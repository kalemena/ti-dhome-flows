[
    {
        "id": "8627a08f.2f4c18",
        "type": "tab",
        "label": "Notifications",
        "disabled": false,
        "info": ""
    },
    {
        "id": "d06e385b.de11c8",
        "type": "tab",
        "label": "Sensors",
        "disabled": false,
        "info": ""
    },
    {
        "id": "112e9cf8.590b23",
        "type": "tab",
        "label": "MessageQueue",
        "disabled": false,
        "info": ""
    },
    {
        "id": "4fc69d2d.235124",
        "type": "telegram bot",
        "z": "",
        "botname": "Ti-dhome-base",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "3000",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "verboselogging": true
    },
    {
        "id": "4c23cd92.778204",
        "type": "serial-port",
        "z": 0,
        "serialport": "/dev/ttyJeeLink",
        "serialbaud": "57600",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "newline": "\\n",
        "bin": "false",
        "out": "char",
        "addchar": false
    },
    {
        "id": "36396f66.41717",
        "type": "serial-port",
        "z": 0,
        "serialport": "/dev/ttyCurrenCost",
        "serialbaud": "57600",
        "databits": "8",
        "parity": "none",
        "stopbits": "1",
        "newline": "\\n",
        "bin": "false",
        "out": "char",
        "addchar": false
    },
    {
        "id": "c38452a5.4f84e8",
        "type": "mqtt-broker",
        "z": "",
        "name": "mqtt",
        "broker": "mqtt",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "15",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "56c5e5e6.d3610c",
        "type": "darksky-credentials",
        "z": "",
        "key_identifier": "kalemena"
    },
    {
        "id": "23793ec.9bf0742",
        "type": "catch",
        "z": "8627a08f.2f4c18",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 130,
        "y": 40,
        "wires": [
            [
                "1eadd747.8b08a1"
            ]
        ]
    },
    {
        "id": "1eadd747.8b08a1",
        "type": "debug",
        "z": "8627a08f.2f4c18",
        "name": "Debug",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 620,
        "y": 40,
        "wires": []
    },
    {
        "id": "8ada82a3.815fc8",
        "type": "telegram sender",
        "z": "8627a08f.2f4c18",
        "name": "Status",
        "bot": "4fc69d2d.235124",
        "x": 1080,
        "y": 210,
        "wires": [
            [
                "bd0c93c7.885df"
            ]
        ]
    },
    {
        "id": "bd0c93c7.885df",
        "type": "debug",
        "z": "8627a08f.2f4c18",
        "name": "Status",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1210,
        "y": 210,
        "wires": []
    },
    {
        "id": "fa30df76.e0def",
        "type": "function",
        "z": "8627a08f.2f4c18",
        "name": "Hello",
        "func": "var content = \"\"\nif(msg.payload === 1) {\n    content = \"Good morning!\"\n} else {\n    content = \"Good night !\"\n}\n\nmsg.payload = {\n    \"chatId\": context.global.telegramrecipients,\n    \"type\": \"message\",\n    \"options\": { \"parse_mode\": \"Markdown\" },\n    \"content\": content\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 910,
        "y": 210,
        "wires": [
            [
                "8ada82a3.815fc8"
            ]
        ]
    },
    {
        "id": "cb68db5a.bdbca8",
        "type": "inject",
        "z": "8627a08f.2f4c18",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "x": 120,
        "y": 110,
        "wires": [
            [
                "177a4b9.7ffc534",
                "436b2017.90da28"
            ]
        ]
    },
    {
        "id": "8b517c2b.d93ed8",
        "type": "function",
        "z": "8627a08f.2f4c18",
        "name": "Meteo",
        "func": "var message = msg.payload.detail + '\\n' + \n    \"temp=\" + msg.data.currently.temperature + \"°C (\" + msg.payload.mintemp + \"°C to \" + msg.payload.maxtemp + \"°C) \\n\" +\n    \"humidity=\" + (msg.payload.humidity * 100) + \"%\\n\" +\n    \"pressure=\" + msg.data.currently.pressure + \"hPa\\n\" +\n    \"windspeed=\" + msg.payload.windspeed + \"km/h\\n\" +\n    \"winddirection=\" + msg.payload.winddirection + \"\\n\" + \n    \"clouds=\" + (msg.payload.clouds * 100) + \"%\";\n    \nmsg.payload = {\n    \"chatId\": context.global.telegramrecipients,\n    \"type\": \"message\",\n    \"options\": { \"parse_mode\": \"Markdown\" },\n    \"content\": message \n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 910,
        "y": 300,
        "wires": [
            [
                "8ada82a3.815fc8"
            ]
        ]
    },
    {
        "id": "177a4b9.7ffc534",
        "type": "credentials",
        "z": "8627a08f.2f4c18",
        "name": "K",
        "props": [
            {
                "value": "telegramrecipients",
                "type": "msg"
            },
            {
                "value": "telegramusers",
                "type": "msg"
            }
        ],
        "x": 290,
        "y": 80,
        "wires": [
            [
                "873622d3.9c2c98"
            ]
        ]
    },
    {
        "id": "eedf2b90.5761",
        "type": "debug",
        "z": "8627a08f.2f4c18",
        "name": "Debug",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 620,
        "y": 80,
        "wires": []
    },
    {
        "id": "873622d3.9c2c98",
        "type": "function",
        "z": "8627a08f.2f4c18",
        "name": "Save",
        "func": "context.global.telegramrecipients = msg.telegramrecipients\nreturn { topic: 'continue' };",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 80,
        "wires": [
            [
                "eedf2b90.5761"
            ]
        ]
    },
    {
        "id": "e9d7a1fd.be1e5",
        "type": "catch",
        "z": "d06e385b.de11c8",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 140,
        "y": 70,
        "wires": [
            [
                "b4de4531.e18c6"
            ]
        ]
    },
    {
        "id": "b4de4531.e18c6",
        "type": "debug",
        "z": "d06e385b.de11c8",
        "name": "Debug",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 650,
        "y": 70,
        "wires": []
    },
    {
        "id": "c95e00f9.370ef",
        "type": "inject",
        "z": "d06e385b.de11c8",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "4f426855.e9451"
            ]
        ]
    },
    {
        "id": "6702fe6d.7775d8",
        "type": "debug",
        "z": "d06e385b.de11c8",
        "name": "Debug",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 650,
        "y": 120,
        "wires": []
    },
    {
        "id": "84f43015.9d08c",
        "type": "yaml",
        "z": "d06e385b.de11c8",
        "property": "payload",
        "name": "",
        "x": 500,
        "y": 120,
        "wires": [
            [
                "6702fe6d.7775d8"
            ]
        ]
    },
    {
        "id": "4f426855.e9451",
        "type": "file in",
        "z": "d06e385b.de11c8",
        "name": "ti-dhome.yaml",
        "filename": "/opt/data/ti-dhome.yaml",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 330,
        "y": 120,
        "wires": [
            [
                "84f43015.9d08c"
            ]
        ]
    },
    {
        "id": "91974a7f.e2fe4",
        "type": "mqtt in",
        "z": "112e9cf8.590b23",
        "name": "docker sensors/+/+/+/+/+",
        "topic": "sensors/+/+/+/+/+",
        "qos": "2",
        "datatype": "auto",
        "broker": "c38452a5.4f84e8",
        "x": 330,
        "y": 80,
        "wires": [
            [
                "c451b641.f25a18"
            ]
        ]
    },
    {
        "id": "c451b641.f25a18",
        "type": "debug",
        "z": "112e9cf8.590b23",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 750,
        "y": 80,
        "wires": []
    },
    {
        "id": "72bb0768.1bdbd8",
        "type": "comment",
        "z": "112e9cf8.590b23",
        "name": "Tests",
        "info": "",
        "x": 110,
        "y": 80,
        "wires": []
    },
    {
        "id": "613655ae.7a0704",
        "type": "serial in",
        "z": "d06e385b.de11c8",
        "name": "Jeelink",
        "serial": "4c23cd92.778204",
        "x": 130,
        "y": 300,
        "wires": [
            [
                "922e5b14.64ef1"
            ]
        ]
    },
    {
        "id": "922e5b14.64ef1",
        "type": "function",
        "z": "d06e385b.de11c8",
        "name": "Parse JeeLink",
        "func": "var s = msg.payload.split(' ')\nif(s[0] === 'ROOM') {\n    var type = ''\n    var nodeid = (\"00000\" + s[1]).slice (-5)\n    var entry = s[2]\n    var value = s[4].replace(/(\\r\\n|\\n|\\r)/gm,\"\");\n    if(s[3] == 0) {\n      type = 'temperature';\n      value = value / 10;\n    } else if(s[3] == 1) {\n      type = 'humidity';\n      value = value / 10;\n    } else if(s[3] == 2) {\n      type = 'pressure';\n      value = value / 10;\n    } else if(s[3] == 3) {\n      type = 'light';\n    } else if(s[3] == 4 && value !== 0) {\n      type = 'battery';\n      value = value / 100;\n    } else if(s[3] == 5) {\n      type = 'soil';\n    } else if(s[3] == 6) {\n      type = 'toggle';\n      value = parseInt(value);\n    }\n    \n    if(type !== '') {\n        msg.topic = 'sensors/' + nodeid + '/entries/' + entry + '/events/' + type;\n        msg.payload = value;\n        return msg;\n    }\n    \n    //setTimeout(function() { this.status({}); }, 500);\n    //this.status({fill:\"green\",shape:\"dot\",text:\"processed\"});\n}\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 580,
        "y": 300,
        "wires": [
            [
                "6cfa6f02.ce921"
            ]
        ]
    },
    {
        "id": "5840b9d9.43453",
        "type": "comment",
        "z": "d06e385b.de11c8",
        "name": "Sensors - MQTT push",
        "info": "",
        "x": 140,
        "y": 180,
        "wires": []
    },
    {
        "id": "4eb57f6e.51aa18",
        "type": "serial in",
        "z": "d06e385b.de11c8",
        "name": "CurrentCost",
        "serial": "36396f66.41717",
        "x": 150,
        "y": 240,
        "wires": [
            [
                "3121b59f.5acfaa"
            ]
        ]
    },
    {
        "id": "3121b59f.5acfaa",
        "type": "xml",
        "z": "d06e385b.de11c8",
        "name": "xml2json",
        "property": "payload",
        "attr": "",
        "chr": "",
        "x": 360,
        "y": 240,
        "wires": [
            [
                "2cb00072.df01f"
            ]
        ]
    },
    {
        "id": "2cb00072.df01f",
        "type": "function",
        "z": "d06e385b.de11c8",
        "name": "Parse CurrentCost",
        "func": "var outputMsgs = [];\n\nif(msg.payload.msg.tmpr) {\n    // Live power\n    if(msg.payload.msg.id == '03967') {\n        // sensors/03967/entries/0/events/temperature\n        var topic = 'sensors/' + msg.payload.msg.id[0] + '/entries/' + msg.payload.msg.sensor[0] + '/events/temperature';\n        outputMsgs.push( { topic:topic, payload: msg.payload.msg.tmpr[0]});\n    }\n    var topic = 'sensors/' + msg.payload.msg.id[0] + '/entries/' + msg.payload.msg.sensor[0] + '/events/power';\n    outputMsgs.push( { topic:topic, payload: msg.payload.msg.ch1[0].watts[0]});\n} else {\n    // History power\n    for (var i in msg.payload.msg.hist[0].data) {\n        var chunk = msg.payload.msg.hist[0].data[i];\n        var chunkClean = {};\n        for (var j in chunk) {\n            chunkClean[j] = chunk[j][0];\n        }\n        var topic = 'sensors/03967/entries/' + chunk.sensor[0] + '/history/power';\n        outputMsgs.push( { topic:topic, payload: chunkClean });\n    }\n}\n\nreturn [ outputMsgs ];",
        "outputs": 1,
        "noerr": 0,
        "x": 590,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "6cfa6f02.ce921",
        "type": "mqtt out",
        "z": "d06e385b.de11c8",
        "name": "mqtt",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "c38452a5.4f84e8",
        "x": 840,
        "y": 270,
        "wires": []
    },
    {
        "id": "a80e2fc5.a2c7b",
        "type": "comment",
        "z": "d06e385b.de11c8",
        "name": "Sensors - Configuration",
        "info": "",
        "x": 140,
        "y": 20,
        "wires": []
    },
    {
        "id": "45d9a893.f40ca8",
        "type": "darksky",
        "z": "8627a08f.2f4c18",
        "darksky": "56c5e5e6.d3610c",
        "name": "Weather Forecast",
        "lon": "-4.574204",
        "lat": "48.4778124",
        "date": "",
        "time": "",
        "mode": "node",
        "lang": "fr",
        "units": "si",
        "x": 340,
        "y": 300,
        "wires": [
            [
                "8b517c2b.d93ed8"
            ]
        ]
    },
    {
        "id": "9b4ceb45.43c628",
        "type": "inject",
        "z": "8627a08f.2f4c18",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 130,
        "y": 300,
        "wires": [
            [
                "f6373746.83f598"
            ]
        ]
    },
    {
        "id": "83721280.40b3e8",
        "type": "comment",
        "z": "8627a08f.2f4c18",
        "name": "Daily news:",
        "info": "",
        "x": 80,
        "y": 150,
        "wires": []
    },
    {
        "id": "436b2017.90da28",
        "type": "function",
        "z": "8627a08f.2f4c18",
        "name": "Fresh deploy",
        "func": "var content = \"Fresh (re-)deploy !\"\n\nmsg.payload = {\n    \"chatId\": context.global.telegramrecipients,\n    \"type\": \"message\",\n    \"options\": { \"parse_mode\": \"Markdown\" },\n    \"content\": content\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 890,
        "y": 170,
        "wires": [
            [
                "8ada82a3.815fc8"
            ]
        ]
    },
    {
        "id": "4881ab4d.cbd20c",
        "type": "simpletime",
        "z": "8627a08f.2f4c18",
        "name": "now",
        "x": 700,
        "y": 250,
        "wires": [
            [
                "57125e6f.c04dd"
            ]
        ]
    },
    {
        "id": "f9f7f04d.3b6e58",
        "type": "csv",
        "z": "8627a08f.2f4c18",
        "name": "",
        "sep": ",",
        "hdrin": true,
        "hdrout": "",
        "multi": "one",
        "ret": "\\n",
        "temp": "",
        "skip": "0",
        "strings": true,
        "x": 580,
        "y": 250,
        "wires": [
            [
                "4881ab4d.cbd20c"
            ]
        ]
    },
    {
        "id": "57125e6f.c04dd",
        "type": "function",
        "z": "8627a08f.2f4c18",
        "name": "Render day events",
        "func": "if (msg.payload.date !== undefined) {\n    \n    var message, bdom, bmonth, byear;\n    bparsed = msg.payload.date.split('/');\n    \n    if(bparsed.length == 3) {\n        // year/month/day\n        bdom = parseInt(bparsed[2])\n        bmonth = parseInt(bparsed[1])\n        byear = parseInt(bparsed[0])\n        \n    } else {\n        // month/day\n        bdom = parseInt(bparsed[1])\n        bmonth = parseInt(bparsed[0])\n        \n    }\n    \n    if((bdom == msg.mydom) && (bmonth == msg.mymonthn)) {\n        // date matches today\n        \n        if(msg.filename.indexOf('saints') !== -1) {\n            message = \"Saints \" + msg.payload.value\n            \n        } else if(msg.filename.indexOf('birthday') !== -1) { \n            if(byear !== undefined) {\n                message = \"Happy \" + (msg.myyear - byear) + \"th Birthday to \" + msg.payload.value + \" (\" + bdom + \"/\" + bmonth + \")\"\n            } else {\n                message = \"Happy Birthday to \" + msg.payload.value + \" (\" + bdom + \"/\" + bmonth + \")\"\n            }\n            \n        } else {\n            message = msg.payload.value\n        }\n        \n        msg.payload = {\n            \"chatId\": context.global.telegramrecipients,\n            \"type\": \"message\",\n            \"options\": { \"parse_mode\": \"Markdown\" },\n            \"content\": message\n        }\n        \n        return msg;\n    }\n}\n\n// Default nothing\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "x": 870,
        "y": 250,
        "wires": [
            [
                "8ada82a3.815fc8"
            ]
        ]
    },
    {
        "id": "f6373746.83f598",
        "type": "readdir",
        "z": "8627a08f.2f4c18",
        "name": "Daily CSV",
        "dir": "/opt/data/daily-events",
        "as": "multi",
        "recursive": false,
        "outproperty": "filename",
        "x": 310,
        "y": 250,
        "wires": [
            [
                "8e4b9462.126df"
            ]
        ]
    },
    {
        "id": "8e4b9462.126df",
        "type": "file in",
        "z": "8627a08f.2f4c18",
        "name": "CSV file",
        "filename": "",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 450,
        "y": 250,
        "wires": [
            [
                "f9f7f04d.3b6e58"
            ]
        ]
    },
    {
        "id": "3fa73a2d.e8f246",
        "type": "switch",
        "z": "8627a08f.2f4c18",
        "name": "Sunrise/set ?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 120,
        "y": 250,
        "wires": [
            [
                "f6373746.83f598"
            ],
            []
        ]
    },
    {
        "id": "892680b5.f07978",
        "type": "sunrise",
        "z": "8627a08f.2f4c18",
        "name": "",
        "lat": "48.45",
        "lon": "-4.59",
        "start": "sunriseEnd",
        "end": "sunsetStart",
        "x": 120,
        "y": 200,
        "wires": [
            [],
            [
                "fa30df76.e0def",
                "3fa73a2d.e8f246",
                "45d9a893.f40ca8"
            ]
        ]
    }
]